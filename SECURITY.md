# 安全性说明

本文档详细描述了微信文章总结器的安全措施、最佳实践和注意事项。

## 目录

- [安全特性](#安全特性)
- [凭证保护](#凭证保护)
- [输入验证](#输入验证)
- [网络安全](#网络安全)
- [代码保护](#代码保护)
- [隐私保护](#隐私保护)
- [报告安全问题](#报告安全问题)

## 安全特性

### 1. 多层防护架构

本应用采用多层安全防护架构：

- **输入验证层**: 所有用户输入经过严格验证和清洗
- **传输安全层**: 仅支持 HTTPS 协议
- **凭证加密层**: API 密钥采用 Fernet 对称加密存储
- **代码混淆层**: 核心代码经过 PyArmor 混淆保护

### 2. 安全审计

项目使用 Bandit 进行自动化安全扫描，定期审查和修复安全问题。

```bash
# 运行安全审计
bandit -r src/ -f txt -o security_audit.txt
```

## 凭证保护

### API 密钥加密

应用实现了基于 Fernet 的对称加密来保护存储在本地的 API 密钥：

1. **加密密钥生成**: 基于机器特征（计算机名、用户名）使用 PBKDF2 派生唯一密钥
2. **密钥存储**: 加密密钥存储在 `~/.wechat_summarizer/.keyfile`（隐藏文件）
3. **凭证加密**: 所有敏感凭证在写入前自动加密，读取时自动解密

### 配置最佳实践

#### 使用环境变量（推荐）

```bash
# .env 文件示例
OPENAI_API_KEY=sk-your-key-here
ANTHROPIC_API_KEY=sk-ant-your-key-here
```

**重要**: 确保 `.env` 文件不会被提交到版本控制系统：

```gitignore
.env
.env.local
*.key
.keyfile
```

#### 权限设置

在 Unix/Linux/Mac 系统上，建议设置适当的文件权限：

```bash
chmod 600 .env
chmod 600 ~/.wechat_summarizer/.keyfile
```

### 凭证轮换

定期轮换 API 密钥以提高安全性：

1. 在服务提供商处生成新密钥
2. 更新 `.env` 文件中的配置
3. 删除旧密钥

## 输入验证

### URL 验证

应用实现了严格的 URL 验证机制：

```python
# 特性
- 协议白名单：仅允许 http/https
- 长度限制：最大 2048 字符
- SSRF 防护：禁止访问内网地址（localhost, 127.0.0.1, 私有 IP 等）
- 域名验证：检查域名格式合法性
```

### 防止注入攻击

- **命令注入**: 所有 subprocess 调用使用列表参数格式，不使用 `shell=True`
- **SQL 注入**: 不适用（应用不使用 SQL 数据库）
- **XSS 防护**: 使用 `bleach` 库清洗 HTML 内容

## 网络安全

### HTTPS 强制

应用仅支持 HTTPS 协议，自动拒绝 HTTP 请求（除非明确使用 http://）。

### 超时设置

所有网络请求设置合理的超时时间，防止挂起和资源耗尽：

- 默认超时: 30 秒
- 最大超时: 120 秒
- 可配置: 通过环境变量调整

### 代理支持

应用支持代理配置，但不会记录或传输代理凭证：

```bash
WECHAT_SUMMARIZER__SCRAPER__PROXY=http://proxy.example.com:8080
```

### SSRF 防护

应用实现了 SSRF（服务器端请求伪造）防护：

1. 禁止访问私有 IP 地址段（RFC1918）
2. 禁止访问 localhost 和回环地址
3. 禁止访问链路本地地址
4. 禁止访问 `.local` 域名

## 代码保护

### 代码混淆

生产环境打包的可执行文件使用 PyArmor 进行代码混淆：

- **混淆范围**: 核心业务逻辑、凭证处理模块、配置管理
- **运行时保护**: PyArmor 运行时保护防止代码提取
- **注意**: 混淆不能完全防止逆向工程，但显著提高攻击成本

### 打包安全

使用 PyInstaller 打包时的安全措施：

```bash
# 单文件模式
pyinstaller --onefile --noconsole --clean 微信文章总结器.spec
```

- 单文件打包减少攻击面
- 清理临时文件防止信息泄露
- 无控制台窗口减少调试信息暴露

## 隐私保护

### 数据收集

**本应用不收集任何用户数据**。所有处理均在本地完成：

- ✅ 文章内容在本地处理
- ✅ API 调用仅发送到用户配置的服务（OpenAI/Anthropic 等）
- ✅ 无遥测、无分析、无追踪
- ✅ 不联网检查更新（除非用户主动操作）

### 本地存储

应用在本地存储的数据：

| 数据类型 | 位置 | 加密 | 用途 |
|---------|------|------|------|
| 缓存文章 | `~/.wechat_summarizer/cache/` | 否 | 加速重复访问 |
| 加密密钥 | `~/.wechat_summarizer/.keyfile` | N/A | 凭证加密 |
| 配置文件 | `~/.wechat_summarizer/config.yaml` | 否 | 用户偏好 |
| 日志文件 | `~/.wechat_summarizer/app.log` | 否 | 问题诊断 |

### 清理数据

用户可以随时删除本地数据：

```bash
# Windows
rmdir /s "%USERPROFILE%\.wechat_summarizer"

# Mac/Linux
rm -rf ~/.wechat_summarizer
```

或使用应用内置的清理功能（设置 -> 清空缓存）。

### 日志脱敏

应用日志会自动清理敏感信息：

- API 密钥会被替换为 `***REDACTED***`
- 完整 URL 可能包含敏感查询参数，会部分隐藏
- 错误堆栈不包含用户数据

## 最佳实践

### 对于开发者

1. **保持依赖更新**
   ```bash
   pip install --upgrade -r requirements.txt
   ```

2. **定期安全审计**
   ```bash
   bandit -r src/
   pip-audit
   ```

3. **代码审查**
   - 关注输入验证
   - 检查异常处理
   - 避免硬编码凭证

### 对于用户

1. **保护 API 密钥**
   - 不要分享 `.env` 文件
   - 不要截图包含密钥的配置界面
   - 定期轮换密钥

2. **验证下载来源**
   - 仅从官方渠道下载应用
   - 验证文件哈希（如提供）

3. **保持软件更新**
   - 关注安全更新通知
   - 及时升级到最新版本

4. **网络环境**
   - 避免在公共 WiFi 下使用（除非使用 VPN）
   - 确保操作系统和杀毒软件最新

## 已知限制

1. **机器绑定加密**: 凭证加密密钥基于机器特征，更换电脑需要重新配置
2. **混淆不是加密**: 代码混淆只能提高逆向成本，不能完全防止
3. **第三方 API**: 应用安全性部分依赖第三方 API 服务的安全性

## 安全更新历史

### v2.1.1 (2026-01-19)

- ✅ 添加凭证加密存储（Fernet）
- ✅ 添加 PyArmor 代码混淆
- ✅ 修复 Bandit 审计发现的问题
- ✅ 增强 URL 验证和 SSRF 防护
- ✅ 添加日志脱敏功能
- ✅ 改进错误消息处理

### v2.1.0 (2026-01-15)

- ✅ 移除剪贴板自动检测功能（隐私考虑）
- ✅ 添加输入框实时 URL 验证
- ✅ 改进重复链接检测

### v2.0.0

- ✅ 初始安全架构
- ✅ HTTPS 强制
- ✅ URL 白名单验证

## 报告安全问题

如果您发现安全漏洞，请**不要**公开披露。请通过以下方式私密报告：

1. **Email**: [security@example.com]（替换为实际邮箱）
2. **GitHub**: 创建私密安全建议（Security Advisory）

我们承诺在 48 小时内响应安全报告。

### 负责任披露政策

我们遵循负责任披露原则：

1. 研究人员报告漏洞
2. 我们确认并评估严重性
3. 我们开发和测试修复
4. 我们发布安全更新
5. 我们公开致谢研究人员（如愿意）

## 合规性

本应用设计遵循以下安全标准和最佳实践：

- OWASP Top 10（Web 应用安全风险）
- CWE/SANS Top 25（最危险的软件弱点）
- PEP 668（Python 依赖管理）

## 技术参考

### 使用的安全库

- **cryptography**: Fernet 对称加密
- **secrets**: 密码学安全的随机数生成
- **bleach**: HTML 清洗和 XSS 防护
- **pydantic**: 数据验证和类型安全

### 安全工具

- **Bandit**: Python 代码安全扫描
- **PyArmor**: 代码混淆和保护
- **pip-audit**: 依赖漏洞扫描

## 许可证

本项目采用 MIT 许可证。安全相关的改进和贡献同样遵循 MIT 许可证。

---

**最后更新**: 2026-01-19  
**版本**: v2.1.1

如有安全疑问或建议，欢迎联系项目维护者。
